<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Modern SUI Wallet Detection</title>
  <style>
    body { 
      background: #181c24; 
      color: #fff; 
      font-family: sans-serif; 
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    h1 {
      color: #6366f1;
      text-align: center;
    }
    .section {
      background: #2a2d36;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .wallet-btn { 
      padding: 12px 24px; 
      border-radius: 8px; 
      font-size: 1.1em; 
      border: none; 
      margin: 8px; 
      background: #6366f1; 
      color: white; 
      cursor: pointer;
      min-width: 250px;
      display: block;
    }
    .wallet-btn:hover:not(:disabled) { 
      background: #5856eb; 
    }
    .wallet-btn:disabled { 
      background: #555; 
      cursor: not-allowed;
    }
    .wallet-btn.not-installed {
      background: #7f1d1d;
    }
    .debug-info {
      background: #1e293b;
      border: 1px solid #475569;
      border-radius: 6px;
      padding: 15px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 0.85em;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    .success { 
      background: #065f46; 
      color: #d1fae5; 
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }
    .error { 
      background: #7f1d1d; 
      color: #fecaca; 
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }
    .info {
      background: #1e40af;
      color: #dbeafe;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }
    .address {
      word-break: break-all;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Modern SUI Wallet Detection</h1>
    
    <div class="section">
      <h2>üîß Complete Debug Information</h2>
      <div id="debug-info" class="debug-info"></div>
    </div>

    <div class="section">
      <h2>üëõ Detected Wallets</h2>
      <div id="wallets"></div>
    </div>

    <div class="section">
      <h2>üìù Connection Status</h2>
      <div id="status"></div>
    </div>
  </div>

  <script>
    const debugDiv = document.getElementById('debug-info');
    const walletsDiv = document.getElementById('wallets');
    const statusDiv = document.getElementById('status');

    // Function pour debug complet
    function updateDebugInfo() {
      const debugInfo = {
        // 1. Objets window basiques
        windowObjects: {
          'window.phantom': !!window.phantom,
          'window.suiWallet': !!window.suiWallet,
          'window.slush': !!window.slush,
          'window.slushWallet': !!window.slushWallet,
          'window.martian': !!window.martian,
          'window.ethosWallet': !!window.ethosWallet,
          'window.suiet': !!window.suiet,
          'window.nightly': !!window.nightly,
        },

        // 2. Recherche exhaustive d'objets wallet
        walletKeywords: Object.keys(window).filter(key => 
          key.toLowerCase().includes('wallet') || 
          key.toLowerCase().includes('sui') ||
          key.toLowerCase().includes('phantom') ||
          key.toLowerCase().includes('slush')
        ),

        // 3. Wallet Standard (protocole moderne)
        walletStandard: {
          'window.wallet': !!window.wallet,
          'window.wallets': !!window.wallets,
          'navigator.wallet': !!navigator.wallet,
        },

        // 4. Event-based detection
        events: {
          'wallet-standard:register-wallet event support': 'window' in globalThis && 'addEventListener' in window,
        },
      };

      // 5. Debug sp√©cifique pour chaque wallet d√©tect√©
      if (window.phantom) {
        debugInfo.phantom = {
          methods: Object.getOwnPropertyNames(window.phantom),
          sui: !!window.phantom.sui,
          suiMethods: window.phantom.sui ? Object.getOwnPropertyNames(window.phantom.sui) : 'N/A',
          request: typeof window.phantom.request,
          connect: typeof window.phantom.connect,
          isPhantom: window.phantom.isPhantom,
        };
      }

      if (window.suiWallet) {
        debugInfo.suiWallet = {
          methods: Object.getOwnPropertyNames(window.suiWallet),
          connect: typeof window.suiWallet.connect,
          isSlush: window.suiWallet.isSlush || window.suiWallet.name === 'Slush',
        };
      }

      // 6. Recherche d'autres propri√©t√©s importantes
      debugInfo.otherImportant = {
        'window.sui': !!window.sui,
        'window.slushApp': !!window.slushApp,
        'document.querySelector([data-wallet])': !!document.querySelector('[data-wallet]'),
      };

      debugDiv.textContent = JSON.stringify(debugInfo, null, 2);
    }

    // Configuration avanc√©e des wallets
    const suiWallets = [
      {
        name: "Slush Wallet (D√©tection avanc√©e)",
        key: "slush-advanced",
        detector: () => {
          // Multiples fa√ßons de d√©tecter Slush
          return window.suiWallet || 
                 window.slush || 
                 window.slushWallet ||
                 (window.sui && window.sui.wallet) ||
                 // Recherche par nom dans les objets disponibles
                 Object.values(window).find(obj => 
                   obj && typeof obj === 'object' && 
                   (obj.name === 'Slush' || obj.name === 'Sui Wallet')
                 );
        },
        connect: async function() {
          const provider = this.detector();
          if (!provider) throw new Error("Slush Wallet not found");
          
          // Essayer diff√©rentes APIs
          try {
            if (provider.connect) {
              const result = await provider.connect();
              return result.accounts?.[0] || result.address || result;
            }
            if (provider.requestConnection) {
              const result = await provider.requestConnection();
              return result.accounts?.[0] || result.address || result;
            }
            if (provider.enable) {
              const result = await provider.enable();
              return result.accounts?.[0] || result.address || result;
            }
            throw new Error("No connect method found");
          } catch (error) {
            throw new Error(`Slush connection failed: ${error.message}`);
          }
        }
      },
      {
        name: "Phantom (Tous r√©seaux)",
        key: "phantom-all",
        detector: () => window.phantom,
        connect: async function() {
          const provider = this.detector();
          if (!provider) throw new Error("Phantom not found");
          
          try {
            // Pour Phantom, essayons juste de connecter normalement
            // Phantom g√®re automatiquement les r√©seaux support√©s
            if (provider.connect) {
              const result = await provider.connect({ onlyIfTrusted: false });
              return result.publicKey?.toString() || result.accounts?.[0] || 'Connected to Phantom';
            }
            throw new Error("No connect method");
          } catch (error) {
            throw new Error(`Phantom connection failed: ${error.message}`);
          }
        }
      },
      {
        name: "Detection par Event Listener",
        key: "event-based",
        detector: () => {
          // Cette m√©thode utilise les √©v√©nements pour d√©tecter les wallets
          return typeof window.addEventListener === 'function';
        },
        connect: async function() {
          return new Promise((resolve, reject) => {
            const timeout = setTimeout(() => {
              reject(new Error("Wallet detection timeout"));
            }, 5000);

            // √âcouter les √©v√©nements de wallets
            const handleWalletEvent = (event) => {
              console.log('Wallet event detected:', event);
              clearTimeout(timeout);
              resolve("Wallet detected via events - check console");
            };

            // Diff√©rents √©v√©nements possibles
            window.addEventListener('wallet-standard:register-wallet', handleWalletEvent);
            window.addEventListener('sui-wallet:register', handleWalletEvent);
            window.addEventListener('slush:register', handleWalletEvent);

            // D√©clencher la d√©tection
            window.dispatchEvent(new CustomEvent('wallet-standard:app-ready'));
          });
        }
      },
      {
        name: "Recherche dynamique dans Window",
        key: "dynamic-search",
        detector: () => true, // Toujours disponible
        connect: async function() {
          // Rechercher dynamiquement les objets wallet
          const walletObjects = [];
          
          for (const key in window) {
            try {
              const obj = window[key];
              if (obj && typeof obj === 'object' && 
                  (typeof obj.connect === 'function' || 
                   typeof obj.enable === 'function' ||
                   typeof obj.request === 'function')) {
                
                walletObjects.push({ key, obj, hasConnect: !!obj.connect });
              }
            } catch (e) {
              // Ignorer les erreurs d'acc√®s
            }
          }

          if (walletObjects.length === 0) {
            throw new Error("No wallet objects with connect methods found");
          }

          // Essayer de connecter avec le premier qui fonctionne
          for (const { key, obj } of walletObjects) {
            try {
              if (obj.connect) {
                const result = await obj.connect();
                return `Connected via ${key}: ${JSON.stringify(result)}`;
              }
            } catch (e) {
              console.log(`Failed to connect via ${key}:`, e);
            }
          }

          return `Found ${walletObjects.length} potential wallet objects: ${walletObjects.map(w => w.key).join(', ')}`;
        }
      }
    ];

    function updateStatus(message, type = 'info') {
      statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
    }

    function createWalletButton(wallet) {
      const btn = document.createElement('button');
      const isDetected = wallet.detector();
      
      if (isDetected) {
        btn.textContent = `‚úÖ Test ${wallet.name}`;
        btn.className = 'wallet-btn';
      } else {
        btn.textContent = `‚ùå ${wallet.name} (Not Detected)`;
        btn.className = 'wallet-btn not-installed';
        btn.disabled = true;
      }
      
      btn.onclick = async () => {
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = '‚è≥ Testing...';
        updateStatus('Testing wallet connection...', 'info');

        try {
          const result = await wallet.connect();
          updateStatus(`üéâ Success with ${wallet.name}!<br><div class="address">${result}</div>`, 'success');
        } catch (error) {
          console.error(`${wallet.name} error:`, error);
          updateStatus(`‚ùå ${wallet.name} failed: ${error.message}`, 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      };
      
      return btn;
    }

    // Fonction d'initialisation
    function init() {
      updateDebugInfo();
      
      // Cr√©er les boutons
      suiWallets.forEach(wallet => {
        walletsDiv.appendChild(createWalletButton(wallet));
      });

      // Status initial
      updateStatus('üîç Wallet detection completed. Check debug info and try the tests above.', 'info');
    }

    // Bouton refresh
    const refreshBtn = document.createElement('button');
    refreshBtn.textContent = 'üîÑ Refresh Detection';
    refreshBtn.className = 'wallet-btn';
    refreshBtn.onclick = () => {
      walletsDiv.innerHTML = '';
      init();
    };

    // Attendre le chargement et l'injection des wallets
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        walletsDiv.appendChild(refreshBtn);
        setTimeout(init, 1500); // Attendre plus longtemps
      });
    } else {
      walletsDiv.appendChild(refreshBtn);
      setTimeout(init, 1500);
    }
  </script>
</body>
</html>
